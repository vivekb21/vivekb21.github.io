<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>UroSonic Acoustic Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Added Outfit font for Product Sans lookalike -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@500;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* NEW THEME: Subtle Emerald & Sage */
            --primary-color: #059669; /* Emerald-600 */
            --primary-light: #ecfdf5; /* Emerald-50 */
            --primary-dark: #047857; /* Emerald-700 */
            --secondary-color: #0d9488; /* Teal-600 */
            --accent-color: #d97706; /* Amber-600 */
            --bg-color: #f0fdf4; /* Very light green tint background */
            --card-bg: #ffffff;
            --text-main: #064e3b; /* Emerald-900 */
            --text-muted: #64748b; /* Slate-500 */
        }
        
        /* Reset and Base Styles */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* FIX: Ensure HTML and Body take up full space without unwanted margin */
        html, body {
            height: 100%;
            padding: 0;
            margin: 0;
            overscroll-behavior: none;
        }

        body {
            font-family: 'Inter', 'Noto Sans Devanagari', sans-serif;
            background-color: #111827; 
            display: flex;
            justify-content: center;
            align-items: flex-start; /* FIX: Align to top to prevent centralizing blank space */
            min-height: 100vh;
            overflow: hidden; /* Prevent body scroll on mobile */
        }

        /* --- MAIN APP CONTAINER --- */
        #mobile-frame {
            background-color: var(--bg-color);
            position: relative;
            width: 100%;
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic viewport height for mobile */
            overflow: hidden;
            display: flex;
            flex-direction: column; /* Stack Layout: Header -> Content -> Nav */
            
            /* Desktop Styling Defaults */
            max-width: none;
            max-height: none;
            box-shadow: none;
            border-radius: 0;
        }
        
        /* Desktop/Tablet "Mockup" Mode Override */
        @media (min-width: 450px) {
            #mobile-frame {
                max-width: 400px;
                height: 90vh;
                max-height: 850px;
                box-shadow: 0 0 0 12px #1f2937, 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                border-radius: 40px;
                align-self: center; /* Center vertically only in mockup view */
            }
        }

        /* --- HEADER --- */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 1.5rem;
            /* Handle Safe Area for Notch */
            padding-top: calc(1.5rem + env(safe-area-inset-top)); 
            
            border-radius: 0 0 24px 24px;
            box-shadow: 0 4px 20px -5px rgba(5, 150, 105, 0.4);
            z-index: 10;
            flex-shrink: 0; /* Prevent header shrinking */
            position: relative;
            overflow: hidden;
        }
        
        /* Font Update for Header Title */
        #header-title {
            font-family: 'Product Sans', 'Outfit', sans-serif;
        }
        
        /* Larger radius for desktop mockup */
        @media (min-width: 450px) {
            .header {
                padding-top: 2.5rem;
                border-radius: 0 0 32px 32px;
            }
        }

        /* --- SCROLLABLE CONTENT --- */
        .content {
            flex-grow: 1; /* Take up all available middle space */
            padding: 1.5rem;
            overflow-y: auto; /* Scrollable */
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
            /* No padding-bottom needed here anymore due to flex layout */
        }
        .content::-webkit-scrollbar {
            display: none;
        }

        /* --- BOTTOM NAVIGATION --- */
        .bottom-nav {
            background-color: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-around;
            padding: 0.75rem 0.5rem;
            /* Handle Home Bar */
            padding-bottom: calc(0.75rem + env(safe-area-inset-bottom)); 
            
            z-index: 20;
            box-shadow: 0 -4px 15px -3px rgba(0, 0, 0, 0.05);
            flex-shrink: 0; /* Prevent nav shrinking */
        }

        /* --- COMPONENTS --- */
        .card {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(167, 243, 208, 0.3);
            margin-bottom: 1rem;
            transition: transform 0.2s ease;
        }
        .card:active {
            transform: scale(0.99);
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            padding: 0.875rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(5, 150, 105, 0.3);
            white-space: normal;
            text-align: center;
            line-height: 1.2;
            cursor: pointer;
        }
        .btn:active {
            transform: translateY(1px);
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            box-shadow: none;
        }

        .flow-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #d1fae5;
            border-radius: 12px;
            transition: all 0.2s;
            font-size: 1rem;
            background-color: #f0fdf4;
            color: var(--text-main);
        }
        .flow-input:focus {
            border-color: var(--primary-color);
            background-color: white;
            outline: none;
            box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.1);
        }

        .option-btn {
            border: 2px solid #d1fae5;
            background-color: white;
            border-radius: 16px;
            padding: 1rem 0.5rem;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 80px;
        }
        .option-btn.selected {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
            color: var(--primary-dark);
            box-shadow: 0 0 0 2px var(--primary-color);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
            color: var(--text-muted);
            background: none;
            border: none;
            flex: 1;
            padding: 0.25rem;
            gap: 4px;
            transition: color 0.2s;
            text-align: center;
        }
        .nav-item span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        .nav-item.active {
            color: var(--primary-color);
            font-weight: 600;
        }
        .nav-item.active svg {
            fill: rgba(16, 185, 129, 0.1);
            stroke-width: 2.5px;
        }

        /* Modal Styles */
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(2px);
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white;
            width: 90%;
            max-width: 320px;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        /* Animations */
        @keyframes pulse-record {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            70% { box-shadow: 0 0 0 25px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        .mic-recording {
            animation: pulse-record 1.5s infinite;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-content.open {
            max-height: 600px;
        }
        
        .diary-entry {
            display: flex;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid #f3f4f6;
        }
        .diary-icon {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #d1d5db;
            transition: all 0.3s;
        }
        .dot.active {
            background-color: var(--primary-color);
            width: 24px;
            border-radius: 8px;
        }
        
        #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            font-size: 1.2rem;
            color: var(--primary-color);
            font-weight: bold;
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #d1fae5;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div id="mobile-frame">
    <div id="loading-screen">Loading App...</div>

    <div id="app-header" class="header flex justify-between items-center">
        <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/4 pointer-events-none"></div>
        <div class="absolute bottom-0 left-0 w-48 h-48 bg-black opacity-10 rounded-full blur-2xl translate-y-1/3 -translate-x-1/4 pointer-events-none"></div>

        <div class="relative z-10">
            <h1 id="header-title" class="text-3xl font-bold tracking-tight mb-1">UroSonic</h1>
            <div class="flex items-center gap-2 opacity-90">
                <div class="w-1.5 h-1.5 rounded-full bg-lime-300 shadow-[0_0_8px_rgba(190,242,100,0.8)]"></div>
                <p id="header-subtitle" class="text-xs font-medium tracking-wider uppercase text-emerald-50">Acoustic Analysis</p>
            </div>
        </div>
        
        <div class="relative z-10 flex items-center gap-3">
             <div class="relative group">
                <select id="lang-select" onchange="setLanguage(this.value)" class="appearance-none bg-white/10 border border-white/20 text-white text-xs font-medium py-2 pl-3 pr-7 rounded-full backdrop-blur-md focus:outline-none focus:bg-white/20 cursor-pointer hover:bg-white/20 transition-colors">
                    <option value="en" class="text-gray-900">ENG</option>
                    <option value="hi" class="text-gray-900">हिंदी</option>
                    <option value="mr" class="text-gray-900">मराठी</option>
                </select>
                <i data-lucide="globe" class="w-3 h-3 text-white absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none opacity-80"></i>
            </div>

            <div id="profile-indicator" onclick="editProfile()" class="bg-white/10 border border-white/20 p-2.5 rounded-full backdrop-blur-md cursor-pointer hover:bg-white/20 transition shadow-lg group">
                <i data-lucide="user" class="w-5 h-5 text-white group-hover:scale-110 transition-transform"></i>
            </div>
        </div>
    </div>

    <div id="app-content" class="content">
    </div>

    <!-- IPSS Bar: Fixed positioning logic simplified -->
    <div id="fixed-ipss-score-bar" class="absolute left-0 right-0 p-4 z-30 pointer-events-none transition-all duration-300 opacity-0 translate-y-full bottom-0">
    </div>

    <div id="ipss-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800" id="ipss-modal-title">IPSS Analysis</h3>
                
            </div>
            <div id="ipss-modal-body" class="space-y-4">
            </div>
            <button onclick="closeIPSSModal()" class="btn w-full mt-6">Close</button>
        </div>
    </div>

    <div id="app-nav" class="bottom-nav">
        <button onclick="goToHomeTab()" class="nav-item active" id="nav-home">
            <i data-lucide="home" class="w-6 h-6"></i>
            <span id="label-home">Home</span>
        </button>
        <button onclick="switchTab('diary')" class="nav-item" id="nav-diary">
            <i data-lucide="notebook-pen" class="w-6 h-6"></i>
            <span id="label-diary">Diary</span>
        </button>
        <button onclick="switchTab('history')" class="nav-item" id="nav-history">
            <i data-lucide="calendar" class="w-6 h-6"></i>
            <span id="label-history">History</span>
        </button>
        <button onclick="switchTab('education')" class="nav-item" id="nav-education">
            <i data-lucide="book-open" class="w-6 h-6"></i>
            <span id="label-learn">Learn</span>
        </button>
    </div>
</div>

<script type="module">
    // --- Constants ---
    const API_MODEL = "gemini-2.5-flash-preview-09-2025";
    const apiKey = ""; 
    const PRIMARY_COLOR = "#059669"; 
    const DAILY_WATER_GOAL = 2500; 

    // --- Audio Analysis Config ---
    //const SPLASH_FREQ_CENTER = 1000; 
    //const SPLASH_FREQ_Q = 0.7;
    const HP_FREQ = 300;     // High-pass cutoff frequency
const LP_FREQ = 3000;    // Low-pass cutoff frequency
    const MIN_RMS_THRESHOLD = 0.004; 
    const FLOW_COEFFICIENT = 60; 
    const FLOW_EXPONENT = 0.5;

    // --- Localization ---
    let currentLanguage = 'en';

    const TRANSLATIONS = {
        en: {
            subtitle: "Acoustic Analysis",
            greeting_morning: "Good Morning",
            greeting_afternoon: "Good Afternoon",
            greeting_evening: "Good Evening",
            ready_checkin: "Ready for your daily check-in?",
            current_profile: "Current Profile",
            edit_details: "Edit Details",
            gender: "Gender",
            age: "Age",
            years: "Years",
            toilet_type: "Toilet Type",
            male: "Male",
            female: "Female",
            western: "Western",
            indian: "Indian",
            urinal: "Urinal",
            new_recording: "New Recording",
            ensure_quiet: "Ensure you are in a quiet environment for the best accuracy.",
            start_test: "Start Test",
            home: "Home",
            diary: "Diary", 
            history: "History",
            learn: "Learn",
            recording_title: "Listening...",
            quiet_please: "Analysis in progress.",
            cancel: "Cancel Recording",
            flow_rate: "Flow Rate (ml/s)",
            complete: "Complete",
            max_flow: "Max Flow (Qmax)",
            total_vol: "Total Volume",
            void_time: "Void Time",
            avg_flow: "Avg Flow (Qave)",
            hydration_level: "Hydration Level",
            smart_analysis: "Smart Analysis",
            pdf: "PDF",
            csv: "CSV",
            share_doctor: "Share with Doctor", 
            recent_records: "Recent Records",
            export_all: "Export All",
            no_records: "No records found yet.",
            daily_summary: "Daily Summary", 
            intake: "Intake",
            output: "Output",
            log_intake: "Log Intake",
            log_output: "Log Output",
            urgency: "Urgency",
            leakage: "Leakage",
            none: "None",
            mild: "Mild",
            severe: "Severe",
            quick_log: "Quick Log",
            todays_logs: "Today's Logs",
            understanding_flow: "Understanding Flow",
            understanding_desc: "Uroflowmetry measures the volume of urine released from the body, the speed with which it is released, and how long the release takes.",
            disclaimer: "Disclaimer",
            disclaimer_text: "This app is an acoustic screening tool and does not provide a medical diagnosis. Always verify abnormal results with clinical uroflowmetry.",
            save_changes: "Save Changes",
            display_name: "Display Name",
            cancel_btn: "Cancel",
            analysis_results: "Analysis Results",
            time_to_max: "Time to Max",
            flow_time: "Flow Time",
            hesitancy: "Hesitancy",
            qmax_title: "What is Qmax?",
            qmax_desc: "Qmax is the maximum flow rate, measured in milliliters per second (ml/s). For adult males, >15 ml/s is generally normal.",
            vol_title: "What is Voided Volume?",
            vol_desc: "This is the total amount of urine passed. Accurate flow rates usually require a voided volume of at least 150ml.",
            doc_title: "When to see a doctor?",
            doc_desc: "Consult a urologist if flow rate is consistently low (<10 ml/s) or if you experience pain.",
            prep_title: "Preparing for test",
            prep_desc: "Do not empty your bladder for 2-3 hours before the test. You should have a strong urge.",
            stop_test: "Stop Test",
            error_mic_perm: "Microphone Access Denied",
            error_mic_msg: "Please grant microphone permission to record your flow. Check your browser or device settings.",
            retry: "Retry Access",
            prep_header: "Preparation",
            instr_dist: "Place phone approx 15-20cm away from the toilet bowl.",
            instr_quiet: "Ensure the room is quiet. Turn off fans or taps.",
            instr_void: "Press 'Start Recording' just before you start voiding.",
            start_recording: "Start Recording",
            add_entry: "Add Entry",
            drink_type: "Drink Type",
            amount_ml: "Amount (ml)",
            // Tutorial
            tut_1_title: "Welcome to UroSonic",
            tut_1_desc: "Monitor your urinary health using advanced acoustic analysis technology right from your smartphone.",
            tut_2_title: "How it Works",
            tut_2_desc: "The app listens to the sound of your urine flow to estimate flow rate, volume, and other clinical metrics.",
            tut_3_title: "Privacy First",
            tut_3_desc: "Your recordings are processed locally on your device. We do not store or upload your audio files.",
            next: "Next",
            get_started: "Get Started",
            skip: "Skip",
            // IPSS
            ipss_score: "IPSS Score",
            ipss_mild: "Mild Symptoms",
            ipss_moderate: "Moderate Symptoms",
            ipss_severe: "Severe Symptoms",
            ipss_desc_mild: "Your symptoms are mild. Usually, no treatment is needed, but lifestyle changes may help.",
            ipss_desc_mod: "Your symptoms are moderate. Consult a doctor to discuss management options.",
            ipss_desc_sev: "Your symptoms are severe. It is recommended to see a urologist for evaluation.",
            // IPSS Questions
            ipss_q1: "Incomplete Emptying",
            ipss_q1_sub: "How often have you had the sensation of not emptying your bladder completely?",
            ipss_q2: "Frequency",
            ipss_q2_sub: "How often have you had to urinate again less than two hours after you finished urinating?",
            ipss_q3: "Intermittency",
            ipss_q3_sub: "How often have you found you stopped and started again several times when you urinated?",
            ipss_q4: "Urgency",
            ipss_q4_sub: "How often have you found it difficult to postpone urination?",
            ipss_q5: "Weak Stream",
            ipss_q5_sub: "How often have you had a weak urinary stream?",
            ipss_q6: "Straining",
            ipss_q6_sub: "How often have you had to push or strain to begin urination?",
            ipss_q7: "Nocturia",
            ipss_q7_sub: "How many times did you typically get up to urinate from the time you went to bed?",
            step_demographics: "Step 1: Demographics",
            step_symptoms: "Step 2: Symptom Score (IPSS)",
            next_symptoms: "Next: Symptoms",
            never: "Never",
            always: "Always",
            last_void: "Last Void",
            hydration: "Hydration",
            click_significance: "Click for significance",
            ipss_score_label: "IPSS Score",
            
            // IPSS Answer Options
            ipss_opt_0: "Not at all",
            ipss_opt_1: "Less than 1 time in 5",
            ipss_opt_2: "Less than half the time",
            ipss_opt_3: "About half the time",
            ipss_opt_4: "More than half the time",
            ipss_opt_5: "Almost always",
            
            // IPSS Nocturia Specific Options
            ipss_nocturia_0: "None",
            ipss_nocturia_1: "1 time",
            ipss_nocturia_2: "2 times",
            ipss_nocturia_3: "3 times",
            ipss_nocturia_4: "4 times",
            ipss_nocturia_5: "5 or more times"
        },
        hi: {
            subtitle: "ध्वनिक विश्लेषण",
            greeting_morning: "शुभ प्रभात",
            greeting_afternoon: "शुभ दोपहर",
            greeting_evening: "शुभ संध्या",
            ready_checkin: "क्या आप अपनी दैनिक जांच के लिए तैयार हैं?",
            current_profile: "वर्तमान प्रोफ़ाइल",
            edit_details: "विवरण बदलें",
            gender: "लिंग",
            age: "आयु",
            years: "वर्ष",
            toilet_type: "शौचालय का प्रकार",
            male: "पुरुष",
            female: "महिला",
            western: "वेस्टर्न",
            indian: "भारतीय",
            urinal: "मूत्रालय",
            new_recording: "नई रिकॉर्डिंग",
            ensure_quiet: "सर्वोत्तम सटीकता के लिए शांत वातावरण सुनिश्चित करें।",
            start_test: "टेस्ट शुरू करें",
            home: "होम",
            diary: "डायरी",
            history: "इतिहास",
            learn: "जानें",
            recording_title: "रिकॉर्डिंग...",
            quiet_please: "कृपया शांत रहें।",
            cancel: "रद्द करें",
            flow_rate: "प्रवाह दर (ml/s)",
            complete: "पूर्ण",
            max_flow: "अधिकतम प्रवाह",
            total_vol: "कुल मात्रा",
            void_time: "समय",
            avg_flow: "औसत प्रवाह",
            hydration_level: "जलयोजन स्तर",
            smart_analysis: "स्मार्ट विश्लेषण",
            pdf: "पीडीएफ",
            csv: "सीएसवी",
            share_doctor: "डॉक्टर के साथ साझा करें",
            recent_records: "हाल के रिकॉर्ड",
            export_all: "सभी निर्यात",
            no_records: "कोई रिकॉर्ड नहीं मिला।",
            daily_intake: "दैनिक जल सेवन",
            quick_log: "त्वरित लॉग",
            todays_logs: "आज के लॉग",
            understanding_flow: "प्रवाह को समझें",
            understanding_desc: "यूरोफ्लोमेट्री शरीर से निकलने वाले मूत्र की मात्रा और गति को मापती है।",
            disclaimer: "अस्वीकरण",
            disclaimer_text: "यह ऐप केवल एक स्क्रीनिंग टूल है और चिकित्सा निदान प्रदान नहीं करता है।",
            save_changes: "परिवर्तन सहेजें",
            display_name: "नाम",
            cancel_btn: "रद्द",
            analysis_results: "विश्लेषण परिणाम",
            time_to_max: "अधिकतम तक समय",
            flow_time: "प्रवाह समय",
            hesitancy: "हिचकिचाहट (Hesitancy)",
            qmax_title: "Qmax क्या है?",
            qmax_desc: "Qmax अधिकतम प्रवाह दर है (ml/s)। वयस्क पुरुषों के लिए, >15 ml/s सामान्य माना जाता है।",
            vol_title: "वॉयडेड वॉल्यूम क्या है?",
            vol_desc: "यह पारित मूत्र की कुल मात्रा है। सटीक परिणामों के लिए कम से कम 150 मिलीलीटर मात्रा आवश्यक है।",
            doc_title: "डॉक्टर को कब दिखाएं?",
            doc_desc: "यदि प्रवाह दर लगातार कम (<10 ml/s) है या आपको दर्द का अनुभव होता है तो यूरोलॉजिस्ट से सलाह लें।",
            prep_title: "टेस्ट की तैयारी",
            prep_desc: "टेस्ट से 2-3 घंटे पहले अपना मूत्राशय खाली न करें। आपको तेज इच्छा होनी चाहिए।",
            stop_test: "टेस्ट रोकें",
            error_mic_perm: "माइक एक्सेस अस्वीकृत",
            error_mic_msg: "प्रवाह रिकॉर्ड करने के लिए कृपया माइक की अनुमति दें।",
            retry: "पुन: प्रयास करें",
            prep_header: "तैयारी",
            instr_dist: "फोन को शौचालय से लगभग 15-20 सेमी दूर रखें।",
            instr_quiet: "सुनिश्चित करें कि कमरा शांत है। पंखे बंद करें।",
            instr_void: "पेशाब शुरू करने से ठीक पहले 'रिकॉर्डिंग शुरू करें' दबाएं।",
            start_recording: "रिकॉर्डिंग शुरू करें",
            add_entry: "प्रविष्टि जोड़ें",
            drink_type: "पेय प्रकार",
            amount_ml: "मात्रा (ml)",
            tut_1_title: "UroSonic में स्वागत है",
            tut_1_desc: "सीधे अपने स्मार्टफोन से उन्नत ध्वनिक विश्लेषण तकनीक का उपयोग करके अपने मूत्र स्वास्थ्य की निगरानी करें।",
            tut_2_title: "यह कैसे काम करता है",
            tut_2_desc: "ऐप प्रवाह दर और मात्रा का अनुमान लगाने के लिए आपके मूत्र प्रवाह की आवाज़ सुनता है।",
            tut_3_title: "गोपनीयता पहले",
            tut_3_desc: "आपकी रिकॉर्डिंग आपके डिवाइस पर स्थानीय रूप से संसाधित होती हैं।",
            next: "अगला",
            get_started: "शुरू करें",
            skip: "छोड़ें",
            ipss_score: "IPSS स्कोर",
            ipss_mild: "हल्के लक्षण",
            ipss_moderate: "मध्यम लक्षण",
            ipss_severe: "गंभीर लक्षण",
            ipss_desc_mild: "आपके लक्षण हल्के हैं। आमतौर पर, किसी उपचार की आवश्यकता नहीं होती है।",
            ipss_desc_mod: "आपके लक्षण मध्यम हैं। प्रबंधन विकल्पों पर चर्चा करने के लिए डॉक्टर से परामर्श लें।",
            ipss_desc_sev: "आपके लक्षण गंभीर हैं। मूल्यांकन के लिए यूरोलॉजिस्ट को दिखाना अनुशंसित है।",
            
            // IPSS Hindi
            ipss_q1: "अपूर्ण खाली होना",
            ipss_q1_sub: "पेशाब करने के बाद आपको कितनी बार लगा कि मूत्राशय पूरी तरह खाली नहीं हुआ?",
            ipss_q2: "बारंबारता",
            ipss_q2_sub: "आपको कितनी बार 2 घंटे से कम समय में दोबारा पेशाब करना पड़ा?",
            ipss_q3: "रुक-रुक कर आना",
            ipss_q3_sub: "पेशाब करते समय कितनी बार प्रवाह रुका और फिर शुरू हुआ?",
            ipss_q4: "तात्कालिकता",
            ipss_q4_sub: "पेशाब को रोकना कितना मुश्किल था?",
            ipss_q5: "कमजोर धार",
            ipss_q5_sub: "आपको कितनी बार कमजोर मूत्र प्रवाह हुआ?",
            ipss_q6: "जोर लगाना",
            ipss_q6_sub: "पेशाब शुरू करने के लिए आपको कितनी बार जोर लगाना पड़ा?",
            ipss_q7: "नोक्टुरिया",
            ipss_q7_sub: "रात में सोने के बाद आपको कितनी बार पेशाब करने उठना पड़ा?",
            step_demographics: "चरण 1: विवरण",
            step_symptoms: "चरण 2: लक्षण स्कोर",
            next_symptoms: "अगला: लक्षण",
            never: "कभी नहीं",
            always: "हमेशा",
            last_void: "अंतिम प्रवाह",
            hydration: "जलयोजन",
            click_significance: "महत्व के लिए क्लिक करें",
            ipss_score_label: "IPSS स्कोर",

            // IPSS Answer Options Hindi
            ipss_opt_0: "बिल्कुल नहीं",
            ipss_opt_1: "5 में से 1 बार से कम",
            ipss_opt_2: "आधे से कम समय",
            ipss_opt_3: "लगभग आधा समय",
            ipss_opt_4: "आधे से अधिक समय",
            ipss_opt_5: "लगभग हमेशा",

            // NEW: IPSS Nocturia Specific Options (Hindi)
            ipss_nocturia_0: "नहीं",
            ipss_nocturia_1: "1 बार",
            ipss_nocturia_2: "2 बार",
            ipss_nocturia_3: "3 बार",
            ipss_nocturia_4: "4 बार",
            ipss_nocturia_5: "5 या अधिक बार"
        },
        mr: {
            subtitle: "ध्वनिक विश्लेषण",
            greeting_morning: "शुभ प्रभात",
            greeting_afternoon: "शुभ दुपार",
            greeting_evening: "शुभ संध्या",
            ready_checkin: "आपल्या दैनंदिन तपासणीसाठी तयार आहात?",
            current_profile: "सध्याचे प्रोफाइल",
            edit_details: "तपशील बदला",
            gender: "लिंग",
            age: "वय",
            years: "वर्षे",
            toilet_type: "टॉयलेटचा प्रकार",
            male: "पुरुष",
            female: "स्त्री",
            western: "वेस्टर्न",
            indian: "भारतीय",
            urinal: "मूत्रालय",
            new_recording: "नवीन रेकॉर्डिंग",
            ensure_quiet: "अचूकतेसाठी शांत वातावरणात असल्याची खात्री करा.",
            start_test: "चाचणी सुरू करा",
            home: "होम",
            diary: "डायरी",
            history: "इतिहास",
            learn: "शिका",
            recording_title: "रेकॉर्डिंग सुरू आहे...",
            quiet_please: "कृपया शांत राहा.",
            cancel: "रद्द करा",
            flow_rate: "प्रवाह दर (ml/s)",
            complete: "पूर्ण",
            max_flow: "कमाल प्रवाह",
            total_vol: "एकूण प्रमाण",
            void_time: "वेळ",
            avg_flow: "सरासरी प्रवाह",
            hydration_level: "पाणी पातळी",
            smart_analysis: "स्मार्ट विश्लेषण",
            pdf: "पीडीएफ",
            csv: "सीएसवी",
            share_doctor: "डॉक्टरांशी शेअर करा",
            recent_records: "अलीकडील रेकॉर्ड",
            export_all: "निर्यात",
            no_records: "अद्याप कोणतीही नोंद नाही.",
            daily_intake: "दैनिक पाणी",
            quick_log: "जलद नोंद",
            todays_logs: "आजच्या नोंदी",
            understanding_flow: "प्रवाह समजून घ्या",
            understanding_desc: "यूरोफ्लोमेट्री लघवीचे प्रमाण आणि गती मोजते.",
            disclaimer: "अस्वीकरण",
            disclaimer_text: "हे ॲप वैद्यकीय निदानासाठी नाही. कृपया डॉक्टरांचा सल्ला घ्या.",
            save_changes: "जतन करा",
            display_name: "नाव",
            cancel_btn: "रद्द",
            analysis_results: "विश्लेषण परिणाम",
            time_to_max: "कमाल प्रवाहाची वेळ",
            flow_time: "प्रवाह वेळ",
            hesitancy: "हेजिटन्सी (विलंब)",
            qmax_title: "Qmax काय आहे?",
            qmax_desc: "Qmax हा कमाल प्रवाह दर आहे (ml/s). पुरुषांसाठी >15 ml/s सामान्य मानले जाते.",
            vol_title: "व्हॉइडेड व्हॉल्यूम काय आहे?",
            vol_desc: "हे लघवीचे एकूण प्रमाण आहे. अचूक चाचणीसाठी किमान 150ml प्रमाण आवश्यक आहे.",
            doc_title: "डॉक्टरांना कधी भेटावे?",
            doc_desc: "जर प्रवाह दर सतत कमी असेल (<10 ml/s) किंवा त्रास होत असेल तर यूरोलॉजिस्टला भेटा.",
            prep_title: "चाचणीची तयारी",
            prep_desc: "चाचणीच्या 2-3 तास आधी लघवी करू नका. तुम्हाला लघवीची तीव्र भावना असावी.",
            stop_test: "चाचणी थांबवा",
            error_mic_perm: "माइक ॲक्सेस नाकारला",
            error_mic_msg: "फ्लो रेकॉर्ड करण्यासाठी कृपया माइकची परवानगी द्या. ब्राउझर किंवा डिव्हाइस सेटिंग्ज तपासा.",
            retry: "पुन्हा प्रयत्न करा",
            prep_header: "तयारी",
            instr_dist: "फोन टॉयलेटपासून अंदाजे 15-20 सेमी अंतरावर ठेवा.",
            instr_quiet: "खोली शांत असल्याची खात्री करा. पंखे बंद करा.",
            instr_void: "लघवी सुरू करण्यापूर्वी 'रेकॉर्डिंग शुरू करा' दाबा.",
            start_recording: "रेकॉर्डिंग सुरू करा",
            add_entry: "नोंद जोडा",
            drink_type: "पेय प्रकार",
            amount_ml: "प्रमाण (ml)",
            tut_1_title: "UroSonic मध्ये स्वागत आहे",
            tut_1_desc: "आपल्या स्मार्टफोनवरून प्रगत ध्वनिक विश्लेषण तंत्रज्ञानाचा वापर करून आपल्या मूत्र आरोग्याचे निरीक्षण करा.",
            tut_2_title: "हे कसे कार्य करते",
            tut_2_desc: "अॅप प्रवाह दर आणि प्रमाण अंदाज करण्यासाठी आपल्या लघवी प्रवाहाचा आवाज ऐकतो。",
            tut_3_title: "गोपनीयता प्रथम",
            tut_3_desc: "आपले रेकॉर्डिंग आपल्या डिव्हाइसवर स्थानिक पातळीवर प्रक्रिया केली जाते。",
            next: "पुढे",
            get_started: "सुरू करा",
            skip: "वगळा",
            ipss_score: "IPSS स्कोअर",
            ipss_mild: "सौम्य लक्षणे",
            ipss_moderate: "मध्यम लक्षणे",
            ipss_severe: "गंभीर लक्षणे",
            ipss_desc_mild: "आपली लक्षणे सौम्य आहेत. साधारणपणे, उपचारांची आवश्यकता नसते。",
            ipss_desc_mod: "आपली लक्षणे मध्यम आहेत. व्यवस्थापनासाठी डॉक्टरांचा सल्ला घ्या。",
            ipss_desc_sev: "आपली लक्षणे गंभीर आहेत. यूरोलॉजिस्टला भेटणे शिफारस केलेले आहे。",
            
            // IPSS Marathi
            ipss_q1: "अपूर्ण रिकामे होणे",
            ipss_q1_sub: "लघवी केल्यानंतर मूत्राशय पूर्ण रिकामे झाले नाही असे तुम्हाला किती वेळा वाटले?",
            ipss_q2: "वारंवारता",
            ipss_q2_sub: "2 तासांच्या आत तुम्हाला पुन्हा लघवीला जावे लागले असे किती वेळा झाले?",
            ipss_q3: "तुटक प्रवाह",
            ipss_q3_sub: "लघवी करताना प्रवाह थांबला आणि पुन्हा सुरू झाला असे किती वेळा झाले?",
            ipss_q4: "निकड",
            ipss_q4_sub: "लघवी रोखणे किती कठीण होते?",
            ipss_q5: "कमकुवत प्रवाह",
            ipss_q5_sub: "तुमची लघवीची धार किती वेळा कमकुवत होती?",
            ipss_q6: "जोर लावणे",
            ipss_q6_sub: "लघवी सुरू करण्यासाठी तुम्हाला किती वेळा जोर द्यावा लागला?",
            ipss_q7: "रात्री उठणे (Nocturia)",
            ipss_q7_sub: "रात्री झोपल्यानंतर लघवीसाठी किती वेळा उठावे लागले?",
            step_demographics: "पायरी 1: तपशील",
            step_symptoms: "पायरी 2: लक्षणे",
            next_symptoms: "पुढे: लक्षणे",
            never: "कधीच नाही",
            always: "नेहमी",
            last_void: "अंतिम लघवी",
            hydration: "पाणी",
            click_significance: "महत्त्वासाठी क्लिक करा",
            ipss_score_label: "IPSS स्कोअर",

            // IPSS Answer Options Marathi
            ipss_opt_0: "अजिबात नाही",
            ipss_opt_1: "5 पैकी 1 पेक्षा कमी वेळा",
            ipss_opt_2: "अर्ध्यापेक्षा कमी वेळा",
            ipss_opt_3: "साधारणपणे अर्ध्या वेळा",
            ipss_opt_4: "अर्ध्यापेक्षा जास्त वेळा",
            ipss_opt_5: "नेहमी",

            // NEW: IPSS Nocturia Specific Options (Marathi)
            ipss_nocturia_0: "नाही",
            ipss_nocturia_1: "1 वेळा",
            ipss_nocturia_2: "2 वेळा",
            ipss_nocturia_3: "3 वेळा",
            ipss_nocturia_4: "4 वेळा",
            ipss_nocturia_5: "5 किंवा जास्त वेळा"
        }
    };

    // Helper to get translation
    window.t = (key) => {
        return TRANSLATIONS[currentLanguage][key] || TRANSLATIONS['en'][key] || key;
    };

    window.setLanguage = (lang) => {
        currentLanguage = lang;
        updateStaticUI();
        // Force refresh current tab or tutorial
        if(currentPage === 'tutorial') renderTutorial();
        else if(currentTab === 'home') renderHome();
        else switchTab(currentTab);
    };

    function updateStaticUI() {
         document.getElementById('header-subtitle').textContent = t('subtitle');
         document.getElementById('label-home').textContent = t('home');
         document.getElementById('label-diary').textContent = t('diary');
         document.getElementById('label-history').textContent = t('history');
         document.getElementById('label-learn').textContent = t('learn');
    }
    
    // --- State ---
    let currentTab = 'home';
    let currentPage = 'tutorial'; 
    
    // Tutorial State
    let tutorialStep = 1;
    
    // Diary Logic State
    let diaryState = 'list'; 
    let tempLogType = 'intake';

    // Profile & IPSS State
    let profileStep = 1; // 1 = Demographics, 2 = IPSS

    // Audio Processing Variables
    let audioContext = null;
    let microphoneStream = null; 
    let analyser = null;
    //let filterNode = null; 
    let highpassFilter = null; 
let lowpassFilter = null;
    let gainNode = null; 
    let audioDataArray = null;
    let isRecording = false;
    let recordingStartTime = 0;
    let recordingData = []; 
    let animationFrameId = null;

    // Default User Profile
    let userProfile = {
        name: "Vivek Bokka",
        age: 23,
        gender: "Male",
        toiletType: "Western",
        ipss: 0,
        ipssAnswers: [0,0,0,0,0,0,0] // 7 answers
    };

    // Diary Data (Unified)
    let diaryEntries = [
        { id: 1, type: 'intake', date: new Date().toISOString().split('T')[0], time: "09:00 AM", amount: 250, subtype: 'Water' },
        { id: 2, type: 'intake', date: new Date().toISOString().split('T')[0], time: "01:30 PM", amount: 500, subtype: 'Coffee' },
        { id: 3, type: 'output', date: new Date().toISOString().split('T')[0], time: "10:15 AM", amount: 300, urgency: 'Mild', leakage: 'None' }
    ];

    // Mock Database for History
    let historyData = [
        { 
            id: 101, date: "2025-11-29", time: "08:30 AM", 
            qMax: 14.5, qAve: 8.2, volume: 310, voidTime: 38, 
            flowTime: 36, timeToMax: 12, hesitancy: 2, ipss: 5,
            rating: "Normal", aiSummary: "Flow consistent with age." 
        },
        { 
            id: 102, date: "2025-11-29", time: "06:15 PM", 
            qMax: 12.1, qAve: 6.5, volume: 280, voidTime: 43, 
            flowTime: 41, timeToMax: 18, hesitancy: 4, ipss: 12,
            rating: "Slightly Reduced", aiSummary: "Slightly lower peak flow observed." 
        }
    ];

    let currentAnalysis = {
        qMax: 0,
        qAve: 0,
        volume: 0,
        voidTime: 0,
        flowTime: 0,
        timeToMax: 0,
        hesitancy: 0,
        ipss: 0, 
        aiSummary: "Pending analysis...",
        graphPoints: [] 
    };

    // --- DOM Elements ---
    const appContent = document.getElementById('app-content');
    const headerTitle = document.getElementById('header-title');
    const headerSubtitle = document.getElementById('header-subtitle');
    const appHeader = document.getElementById('app-header');
    const appNav = document.getElementById('app-nav');
    const ipssModal = document.getElementById('ipss-modal');
    const ipssModalTitle = document.getElementById('ipss-modal-title');
    const ipssModalBody = document.getElementById('ipss-modal-body');
    // NEW: Get reference to the fixed score bar
    const fixedIpssScoreBar = document.getElementById('fixed-ipss-score-bar');

    // --- HELPER FUNCTIONS ---
    const generateId = () => Math.floor(Math.random() * 10000);
    
    // Globalized to fix ReferenceError
    window.getGreeting = () => {
        const hour = new Date().getHours();
        if (hour < 12) return t('greeting_morning');
        if (hour < 18) return t('greeting_afternoon');
        return t('greeting_evening');
    };

    // --- MOCK AI Call ---
    window.fetchAnalysisSummary = () => {
        // Simulate API call delay
        currentAnalysis.aiSummary = "Analyzing data...";
        
        // This is a placeholder since real LLM calls are disabled for this flow.
        setTimeout(() => {
            let summary = `Your flow analysis shows a Qmax of ${currentAnalysis.qMax} ml/s. `;
            if (currentAnalysis.qMax < 10) {
                summary += "This flow rate is low, suggesting potential obstruction or a weak detrusor muscle. Please consult your IPSS score and diary entries.";
            } else if (currentAnalysis.qMax > 20) {
                summary += "Your flow rate is strong and within the normal range. Keep monitoring for consistency.";
            } else {
                summary += "Flow is adequate but near the lower limit of normal. Continue tracking and ensure proper hydration.";
            }
            // IMPORTANT: Updated this line to use userProfile.ipss instead of currentAnalysis.ipss for consistency
            summary += ` Your current IPSS score is ${userProfile.ipss} (click score for severity).`;
            
            currentAnalysis.aiSummary = summary;
            
            // Re-render the analysis page to show the result
            currentPage = 'analysis';
            renderHome();
        }, 1500); 
    };

    // --- GLOBAL FUNCTIONS (HOISTED/ATTACHED TO WINDOW) ---

    // --- Tutorial Logic (Moved to Top) ---
    function renderTutorial() {
        appHeader.style.display = 'none';
        appNav.style.display = 'none';
        fixedIpssScoreBar.classList.add('opacity-0', 'pointer-events-none'); // Ensure fixed bar is hidden

        let icon, title, desc;
        if (tutorialStep === 1) {
            icon = "waves";
            title = t('tut_1_title');
            desc = t('tut_1_desc');
        } else if (tutorialStep === 2) {
            icon = "mic";
            title = t('tut_2_title');
            desc = t('tut_2_desc');
        } else {
            icon = "shield-check";
            title = t('tut_3_title');
            desc = t('tut_3_desc');
        }

        appContent.innerHTML = `
            <div class="flex flex-col h-full justify-between pt-10 pb-4 fade-in">
                <div class="flex justify-end px-4">
                    <button onclick="endTutorial()" class="text-emerald-600 font-bold text-sm">${t('skip')}</button>
                </div>
                <div class="flex-grow flex flex-col items-center justify-center text-center px-6">
                    <div class="w-40 h-40 bg-emerald-100 rounded-full flex items-center justify-center mb-8 shadow-lg shadow-emerald-100">
                        <i data-lucide="${icon}" class="w-20 h-20 text-emerald-600"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">${title}</h2>
                    <p class="text-gray-500 leading-relaxed">${desc}</p>
                </div>
                <div class="px-6 space-y-8">
                    <div class="flex justify-center gap-2">
                        <div class="dot ${tutorialStep === 1 ? 'active' : ''}"></div>
                        <div class="dot ${tutorialStep === 2 ? 'active' : ''}"></div>
                        <div class="dot ${tutorialStep === 3 ? 'active' : ''}"></div>
                    </div>
                    <button onclick="nextTutorial()" class="btn w-full shadow-lg text-lg py-4 bg-emerald-600">
                        ${tutorialStep === 3 ? t('get_started') : t('next')}
                    </button>
                </div>
            </div>
        `;
        lucide.createIcons();
    }

    window.nextTutorial = () => {
        if (tutorialStep < 3) {
            tutorialStep++;
            renderTutorial();
        } else {
            endTutorial();
        }
    };

    window.endTutorial = () => {
        try {
            localStorage.setItem('seenTutorial', 'true');
        } catch(e) { console.log("LocalStorage denied"); }
        appHeader.style.display = 'flex';
        appNav.style.display = 'flex';
        profileStep = 1;
        currentPage = 'edit-profile'; 
        renderHome();
    };


    // --- Graph Logic ---
    function drawGraph(canvasId, qMax) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        
        let points = [];
        // UPDATED: Check for existing smoothed graph points first
        if (currentAnalysis.graphPoints && currentAnalysis.graphPoints.length > 0) {
            points = currentAnalysis.graphPoints;
        } else {
            // IMPROVED FALLBACK: Realistic Bell-shaped curve instead of Sine wave
            const duration = currentAnalysis.voidTime > 0 ? currentAnalysis.voidTime + 5 : 40;
            const peakTime = duration * 0.4;
            
            for(let t=0; t<=duration; t+=0.5) {
                let flow = 0;
                // Skewed bell curve function roughly mimicking normal uroflow
                if (t > 2 && t < duration - 2) {
                    const x = t - 2;
                    // Gamma distribution-like shape: x^k * e^(-x/theta)
                    // Simplified: rise fast, fall slow
                    const rise = Math.pow(x, 2);
                    const fall = Math.exp(-x / (duration/5));
                    const rawY = rise * fall;
                    
                    // Normalize peak to qMax
                    // Max of x^2 * e^(-x/A) is at x=2A. Value is (2A)^2 * e^-2.
                    const A = duration / 5;
                    const peakVal = Math.pow(2*A, 2) * Math.exp(-2);
                    flow = (rawY / peakVal) * qMax;
                    
                    // Add slight noise for realism
                    flow += (Math.random() - 0.5) * 0.5;
                }
                if (flow < 0) flow = 0;
                points.push({x: t, y: flow});
            }
        }

        const width = rect.width;
        const height = rect.height;
        const pad = 20;
        
        ctx.clearRect(0, 0, width, height);
        
        // Find max X and Y for scaling
        const maxX = points.length > 0 ? points[points.length-1].x : 40;
        // Use qMax for scaling Y, but ensure a minimum scale
        const maxY = Math.max(qMax * 1.2, 25); 

        const scaleX = (x) => pad + (x / maxX) * (width - 2 * pad);
        const scaleY = (y) => height - pad - (y / maxY) * (height - 2 * pad);

        // Grid
        ctx.strokeStyle = '#e5e7eb';
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let i=0; i<=5; i++) {
            const y = pad + (i/5)*(height - 2*pad);
            ctx.moveTo(pad, y);
            ctx.lineTo(width-pad, y);
        }
        ctx.stroke();

        const gradient = ctx.createLinearGradient(0, 0, 0, height);
        gradient.addColorStop(0, "rgba(5, 150, 105, 0.2)");
        gradient.addColorStop(1, "rgba(5, 150, 105, 0.0)");

        if (points.length > 0) {
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.moveTo(scaleX(points[0].x), scaleY(points[0].y));
            points.forEach(p => ctx.lineTo(scaleX(p.x), scaleY(p.y)));
            ctx.lineTo(scaleX(points[points.length-1].x), height - pad);
            ctx.lineTo(scaleX(points[0].x), height - pad);
            ctx.fill();

            ctx.strokeStyle = PRIMARY_COLOR;
            ctx.lineWidth = 3;
            ctx.lineJoin = 'round';
            ctx.beginPath();
            ctx.moveTo(scaleX(points[0].x), scaleY(points[0].y));
            points.forEach(p => ctx.lineTo(scaleX(p.x), scaleY(p.y)));
            ctx.stroke();
        }
    }
    
    // --- Audio Visualization Logic ---
    function startAudioVisualization() {
        // Placeholder for visualizer start call
    }

    // --- Modal Logic ---
    window.showIPSSInfo = (score) => {
        let severity, desc, colorClass;
        if (score <= 7) {
            severity = t('ipss_mild');
            desc = t('ipss_desc_mild');
            colorClass = "text-emerald-600";
        } else if (score <= 19) {
            severity = t('ipss_moderate');
            desc = t('ipss_desc_mod');
            colorClass = "text-amber-600";
        } else {
            severity = t('ipss_severe');
            desc = t('ipss_desc_sev');
            colorClass = "text-red-600";
        }

        ipssModalTitle.textContent = `${t('ipss_score')}: ${score}`;
        ipssModalBody.innerHTML = `
            <div class="text-center p-4 bg-gray-50 rounded-xl">
                <span class="text-xl font-bold ${colorClass} block mb-2">${severity}</span>
                <p class="text-sm text-gray-600">${desc}</p>
            </div>
            <div class="text-xs text-gray-400 mt-4 border-t pt-2">
                Scores: 0-7 (Mild), 8-19 (Moderate), 20-35 (Severe)
            </div>
        `;
        ipssModal.classList.add('active');
    };

    window.closeIPSSModal = () => {
        ipssModal.classList.remove('active');
    };

    // View History Item
    window.viewHistoryItem = (id) => {
        const item = historyData.find(i => i.id === id);
        if (!item) return;
        
        currentAnalysis = {
            qMax: item.qMax,
            qAve: item.qAve || (item.qMax * 0.6).toFixed(1),
            volume: item.volume, 
            voidTime: item.voidTime || 30,
            flowTime: item.flowTime || Math.floor((item.voidTime || 30) * 0.9),
            timeToMax: item.timeToMax || Math.floor((item.voidTime || 30) * 0.3),
            hesitancy: item.hesitancy || 0,
            ipss: item.ipss || 0,
            aiSummary: item.aiSummary || `Historical Record: ${item.rating}`,
            graphPoints: item.graphPoints || [] 
        };
        
        currentPage = 'analysis';
        switchTab('home');
    };

    // Profile & IPSS Logic
    window.setIPSSScore = (index, score) => {
        userProfile.ipssAnswers[index] = parseInt(score);
        // Re-render to update the total score in the fixed bar instantly
        renderHome(); 
    };

    window.goToIPSS = () => {
        const nameInput = document.getElementById('edit-name');
        const ageInput = document.getElementById('edit-age');
        if(nameInput && ageInput) {
             userProfile.name = nameInput.value;
             userProfile.age = ageInput.value;
        }
        profileStep = 2; 
        renderHome();
    };

    window.backToDemographics = () => {
        profileStep = 1;
        renderHome();
    };

    window.saveFullProfile = () => {
        const totalScore = userProfile.ipssAnswers.reduce((a, b) => a + b, 0);
        userProfile.ipss = totalScore;
        currentPage = 'onboarding'; 
        renderHome();
    };

    // Diary Logic
    window.addDiaryEntry = (type) => { diaryState = 'add'; tempLogType = type; renderDiary(); };
    window.cancelDiaryEntry = () => { diaryState = 'list'; renderDiary(); };
    
    window.selectOption = (category, value) => {
        document.getElementById(`log-${category}`).value = value;
        const buttons = document.querySelectorAll(`[id^='btn-${category.substring(0,3)}']`);
        buttons.forEach(btn => {
            if (btn.id === `btn-${category.substring(0,3)}-${value}`) {
                btn.classList.add('selected', 'bg-emerald-50', 'border-emerald-500', 'text-emerald-700');
            } else {
                btn.classList.remove('selected', 'bg-emerald-50', 'border-emerald-500', 'text-emerald-700');
            }
        });
    };

    window.saveDiaryEntry = () => {
        const amountEl = document.getElementById('log-amount');
        const amount = parseInt(amountEl.value);
        if (!amount) return alert("Invalid amount");
        const now = new Date();
        const newEntry = { id: generateId(), type: tempLogType, date: now.toISOString().split('T')[0], time: now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), amount: amount };
        if (tempLogType === 'intake') {
            newEntry.subtype = document.getElementById('log-subtype').value;
        } else {
            newEntry.urgency = document.getElementById('log-urgency').value;
            newEntry.leakage = document.getElementById('log-leakage').value;
        }
        diaryEntries.push(newEntry);
        diaryState = 'list';
        renderDiary();
    };

    // Edit Profile / Start Test
    window.editProfile = () => {
        currentPage = 'edit-profile';
        renderHome();
    };

    window.updateProfileAttribute = (key, value) => {
        userProfile[key] = value;
        renderHome(); 
    };

    window.saveProfile = () => {
        const nameInput = document.getElementById('edit-name').value;
        const ageInput = document.getElementById('edit-age').value;
        if (nameInput && ageInput) {
            userProfile.name = nameInput;
            userProfile.age = ageInput;
            currentPage = 'onboarding';
            renderHome();
        } else {
            alert("Name and Age are required.");
        }
    };

    window.cancelEdit = () => {
        currentPage = 'onboarding';
        renderHome();
    };

    window.startTest = () => {
        currentPage = 'pre-recording';
        renderHome();
    };

    window.beginRecording = () => {
        if (!audioContext || audioContext.state === 'closed') {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioContext.state === 'suspended') {
            audioContext.resume();
        }
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                microphoneStream = stream;
                const source = audioContext.createMediaStreamSource(stream);
                //gainNode = audioContext.createGain();
                //gainNode.gain.value = 6.0; 
                //filterNode = audioContext.createBiquadFilter();
                //filterNode.type = 'bandpass';
                //filterNode.frequency.value = SPLASH_FREQ_CENTER;
                //filterNode.Q.value = SPLASH_FREQ_Q;
                //analyser = audioContext.createAnalyser();
                //analyser.fftSize = 512;
                //audioDataArray = new Uint8Array(analyser.frequencyBinCount);

                //source.connect(gainNode);
                //gainNode.connect(filterNode);
                //filterNode.connect(analyser);
                gainNode = audioContext.createGain();
gainNode.gain.value = 6.0; 

// 1. Create High-Pass Filter (removes rumble below 300Hz)
highpassFilter = audioContext.createBiquadFilter();
highpassFilter.type = 'highpass';
highpassFilter.frequency.value = HP_FREQ; // 300 Hz

// 2. Create Low-Pass Filter (removes hiss above 3000Hz)
lowpassFilter = audioContext.createBiquadFilter();
lowpassFilter.type = 'lowpass';
lowpassFilter.frequency.value = LP_FREQ; // 3000 Hz

analyser = audioContext.createAnalyser();
analyser.fftSize = 512;
audioDataArray = new Uint8Array(analyser.frequencyBinCount);

// 3. Connect Graph: Source -> Gain -> HighPass -> LowPass -> Analyser
source.connect(gainNode);
gainNode.connect(highpassFilter);
highpassFilter.connect(lowpassFilter);
lowpassFilter.connect(analyser);

                isRecording = true;
                recordingStartTime = Date.now();
                recordingData = [];
                currentPage = 'recording';
                renderHome();
                analyzeAudioLoop();
            })
            .catch(err => {
                console.error('Error accessing microphone:', err);
                currentPage = 'mic-error';
                renderHome();
            });
    };

    function analyzeAudioLoop() {
        if (!isRecording) return;

        animationFrameId = requestAnimationFrame(analyzeAudioLoop);

        if (!analyser) return;

        analyser.getByteTimeDomainData(audioDataArray);

        let sum = 0;
        for (let i = 0; i < audioDataArray.length; i++) {
            const x = (audioDataArray[i] - 128) / 128.0; 
            sum += x * x;
        }
        let rms = Math.sqrt(sum / audioDataArray.length);
        
        if(rms < MIN_RMS_THRESHOLD) rms = 0;

        const elapsedTime = (Date.now() - recordingStartTime) / 1000;
        recordingData.push({ time: elapsedTime, rms: rms });

        drawVisualizer(audioDataArray);
    }
    
    function drawVisualizer(dataArray) {
        const canvas = document.getElementById('recording-visualizer');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;

        ctx.clearRect(0, 0, width, height);
        ctx.fillStyle = 'rgb(249, 250, 251)'; 
        ctx.fillRect(0, 0, width, height);

        ctx.lineWidth = 2;
        ctx.strokeStyle = '#059669'; 
        ctx.beginPath();

        const sliceWidth = width * 1.0 / dataArray.length;
        let x = 0;

        for (let i = 0; i < dataArray.length; i++) {
            const v = dataArray[i] / 128.0;
            const y = v * height / 2;

            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }

            x += sliceWidth;
        }

        ctx.lineTo(canvas.width, canvas.height / 2);
        ctx.stroke();
    }
    
    // --- Stop Test ---
    window.stopTest = () => {
        isRecording = false;
        if (audioContext) {
            audioContext.close();
        }
        if (microphoneStream) {
            microphoneStream.getTracks().forEach(track => track.stop());
        }
        cancelAnimationFrame(animationFrameId);

        // --- Post-Processing ---
        const smoothedRMS = [];
        const windowSize = 15; 
        for (let i = 0; i < recordingData.length; i++) {
            let sum = 0;
            let count = 0;
            for (let j = Math.max(0, i - windowSize); j <= Math.min(recordingData.length - 1, i + windowSize); j++) {
                sum += recordingData[j].rms;
                count++;
            }
            smoothedRMS.push(sum / count);
        }

        const flowProfile = recordingData.map((point, index) => {
            const rms = smoothedRMS[index];
            let flow = 0;
            if (rms > MIN_RMS_THRESHOLD) {
                flow = FLOW_COEFFICIENT * Math.pow(rms, FLOW_EXPONENT);
            }
            flow = Math.min(flow, 50); 
            return { x: point.time, y: flow };
        });

        let maxFlow = 0;
        let totalVolume = 0;
        let flowSum = 0;
        let flowCount = 0;
        let startTime = 0;
        let endTime = 0;
        let hasStarted = false;

        for (let i = 1; i < flowProfile.length; i++) {
            const dt = flowProfile[i].x - flowProfile[i-1].x;
            const flow = flowProfile[i].y;
            
            if (flow > 1.0) { 
                if (!hasStarted) {
                    startTime = flowProfile[i].x;
                    hasStarted = true;
                }
                endTime = flowProfile[i].x;
                
                totalVolume += flow * dt;
                flowSum += flow;
                flowCount++;
                if (flow > maxFlow) maxFlow = flow;
            }
        }

        const voidTime = hasStarted ? (endTime - startTime) : 0;
        const avgFlow = flowCount > 0 ? (flowSum / flowCount) : 0;
        const hesitancy = hasStarted ? startTime : 0;
        
        let timeToMax = 0;
        if(hasStarted) {
             const maxFlowPoint = flowProfile.find(p => p.y === maxFlow);
             if(maxFlowPoint) timeToMax = maxFlowPoint.x - startTime;
        }

        // FIX: Use the calculated IPSS score from the user profile
        const finalIPSS = userProfile.ipss; 

        currentAnalysis = {
            qMax: parseFloat(maxFlow.toFixed(1)),
            qAve: parseFloat(avgFlow.toFixed(1)),
            volume: Math.round(totalVolume),
            voidTime: Math.round(voidTime),
            flowTime: Math.round(voidTime),
            timeToMax: parseFloat(timeToMax.toFixed(1)),
            hesitancy: parseFloat(hesitancy.toFixed(1)),
            ipss: finalIPSS, // <-- FIXED: Use finalIPSS
            aiSummary: "Analyzing recorded audio pattern...",
            graphPoints: flowProfile 
        };

        const now = new Date();
        historyData.unshift({
            id: generateId(),
            date: now.toISOString().split('T')[0],
            time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            ...currentAnalysis,
            rating: currentAnalysis.qMax > 15 ? 'Normal' : 'Reduced',
        });

        currentPage = 'analysis';
        renderHome();
        fetchAnalysisSummary(); 
    };

    window.resetHome = () => {
        currentPage = 'onboarding';
        renderHome();
    };

    window.exportData = (type) => {
        // ... (Export Logic) ...
        // Re-implementing simplified export for brevity
        if (type === 'csv') {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Date,Metric,Value\n"
                + `${new Date().toLocaleDateString()},Qmax,${currentAnalysis.qMax}\n`; 
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "uroflow_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else {
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>`;
            lucide.createIcons();
            setTimeout(() => {
                alert("PDF Downloaded.");
                btn.innerHTML = originalText;
                lucide.createIcons();
            }, 1000);
        }
    };

    window.exportAllHistory = () => {
        alert("Exporting " + historyData.length + " records...");
    };

    // --- Share Logic ---
    window.shareReport = async () => {
        const text = `
UroSonic Analysis Report for ${userProfile.name}
Date: ${new Date().toLocaleDateString()}

Max Flow (Qmax): ${currentAnalysis.qMax} ml/s
Avg Flow (Qave): ${currentAnalysis.qAve} ml/s
Voided Volume: ${currentAnalysis.volume} ml
Void Time: ${currentAnalysis.voidTime} s
Hesitancy: ${currentAnalysis.hesitancy} s

AI Summary: ${currentAnalysis.aiSummary}
        `;

        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'UroFlow Report',
                    text: text,
                });
            } catch (err) {
                console.log('Error sharing:', err);
            }
        } else {
            // Fallback for browsers without share API
            alert("Share feature not supported on this browser context. Copying to clipboard instead.\n\n" + text);
        }
    };

    // --- Tab Switching Logic (Globalized) ---
    window.goToHomeTab = () => {
        currentPage = 'onboarding'; // Main Dashboard
        switchTab('home');
    };

    window.switchTab = (tab) => {
        currentTab = tab;
        
        // Update Nav UI
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`nav-${tab}`).classList.add('active');

        // Update Header & Content
        if (tab === 'home') {
            headerTitle.textContent = "UroSonic";
            updateStaticUI();
            renderHome();
        } else if (tab === 'history') {
            headerTitle.textContent = t('history');
            updateStaticUI();
            renderHistory();
        } else if (tab === 'education') {
            headerTitle.textContent = t('learn');
            updateStaticUI();
            renderEducation();
        } else if (tab === 'diary') {
            headerTitle.textContent = t('diary');
            updateStaticUI();
            // Reset to list view when switching to diary tab
            diaryState = 'list';
            renderDiary();
        }
    };


    // --- Render Logic: Diary ---
    function renderDiary() {
        fixedIpssScoreBar.classList.add('opacity-0', 'pointer-events-none'); // Ensure fixed bar is hidden
        if (diaryState === 'list') {
             const todayIntake = diaryEntries.filter(e => e.type === 'intake').reduce((acc, curr) => acc + curr.amount, 0);
             const todayOutput = diaryEntries.filter(e => e.type === 'output').reduce((acc, curr) => acc + curr.amount, 0);
             appContent.innerHTML = `
                <div class="fade-in space-y-6">
                    <div class="card bg-gradient-to-r from-emerald-500 to-teal-600 text-white border-none p-5">
                        <div class="flex justify-between text-center">
                             <div class="flex-1 border-r border-emerald-400/50"><span class="block text-2xl font-bold">${todayIntake}ml</span><span class="text-xs">${t('intake')}</span></div>
                             <div class="flex-1"><span class="block text-2xl font-bold">${todayOutput}ml</span><span class="text-xs">${t('output')}</span></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="addDiaryEntry('intake')" class="btn bg-blue-100 text-blue-800">${t('log_intake')}</button>
                        <button onclick="addDiaryEntry('output')" class="btn bg-amber-100 text-amber-800">${t('log_output')}</button>
                    </div>
                    <div>
                        <h3 class="font-bold text-emerald-800 mb-3">${t('todays_logs')}</h3>
                        <div class="space-y-2">
                            ${diaryEntries.slice().reverse().map(l => `<div class="diary-entry"><div class="diary-icon ${l.type === 'intake' ? 'bg-blue-50 text-blue-500' : 'bg-amber-50 text-amber-500'}"><i data-lucide="${l.type === 'intake' ? 'glass-water' : 'droplet'}" class="w-5 h-5"></i></div><span class="text-sm font-bold w-16">${l.time}</span> <span class="flex-grow">${l.type==='intake'?l.subtype:t('output')}</span> <span class="font-bold">${l.amount}ml</span></div>`).join('')}
                        </div>
                    </div>
                </div>`;
        } else {
             const isIntake = tempLogType === 'intake';
             appContent.innerHTML = `
                <div class="fade-in space-y-6">
                    <div class="flex items-center gap-3 mb-2"><button onclick="cancelDiaryEntry()" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left" class="w-6 h-6 text-gray-600"></i></button><h2 class="text-xl font-bold ${isIntake ? 'text-blue-600' : 'text-amber-600'}">${isIntake ? t('log_intake') : t('log_output')}</h2></div>
                    <div class="card space-y-5">
                        <div><label class="block text-xs font-semibold text-gray-500 uppercase mb-2">${t('amount_ml')}</label><input type="number" id="log-amount" placeholder="e.g. 250" class="flow-input text-lg font-bold"></div>
                        ${isIntake ? `<div><label class="block text-xs font-semibold text-gray-500 uppercase mb-2">${t('drink_type')}</label><select id="log-subtype" class="flow-input bg-white"><option value="Water">Water</option><option value="Coffee">Coffee</option><option value="Tea">Tea</option><option value="Juice">Juice</option><option value="Soda">Soda</option><option value="Alcohol">Alcohol</option><option value="Other">Other</option></select></div>` : 
                        `<div><label class="block text-xs font-semibold text-gray-500 uppercase mb-2">${t('urgency')}</label><div class="flex gap-2"><button id="btn-urg-None" onclick="selectOption('urgency','None')" class="option-btn flex-1 selected">None</button><button id="btn-urg-Mild" onclick="selectOption('urgency','Mild')" class="option-btn flex-1">Mild</button><button id="btn-urg-Severe" onclick="selectOption('urgency','Severe')" class="option-btn flex-1">Severe</button></div><input type="hidden" id="log-urgency" value="None"></div>
                         <div><label class="block text-xs font-semibold text-gray-500 uppercase mb-2">${t('leakage')}</label><div class="flex gap-2"><button id="btn-leak-None" onclick="selectOption('leakage','None')" class="option-btn flex-1 selected">None</button><button id="btn-leak-Small" onclick="selectOption('leakage','Small')" class="option-btn flex-1">Small</button><button id="btn-leak-Large" onclick="selectOption('leakage','Large')" class="option-btn flex-1">Large</button></div><input type="hidden" id="log-leakage" value="None"></div>`}
                    </div>
                    <button onclick="saveDiaryEntry()" class="btn w-full shadow-lg text-lg py-3 mt-4">${t('add_entry')}</button>
                </div>
             `;
             if (!isIntake) { setTimeout(() => { selectOption('urgency', 'None'); selectOption('leakage', 'None'); }, 50); }
        }
        lucide.createIcons();
    }

    // --- Home Tab Render Logic (Updated for Profile Steps) ---
    function renderHome() {
        let html = '';
        fixedIpssScoreBar.classList.add('opacity-0', 'pointer-events-none', '-translate-y-full'); // Default to hidden
        fixedIpssScoreBar.style.transform = '';
        fixedIpssScoreBar.style.paddingBottom = '0';
        fixedIpssScoreBar.innerHTML = '';


        if (currentPage === 'onboarding') {
            // DASHBOARD VIEW
            // Calculate Dashboard Metrics
            const lastRecord = historyData[0] || { qMax: 0, volume: 0, date: '--', ipss: 0 };
            const todayIntake = diaryEntries.filter(e => e.type === 'intake').reduce((acc, curr) => acc + curr.amount, 0);
            const intakeProgress = Math.min((todayIntake / DAILY_WATER_GOAL) * 100, 100);

            html = `
                <div class="fade-in pb-20">
                    <div class="mb-6 flex justify-between items-end">
                         <div>
                            <h2 class="text-2xl font-bold text-emerald-900">${getGreeting()}, ${userProfile.name.split(' ')[0]}</h2>
                            <p class="text-emerald-600/80 text-sm">${t('ready_checkin')}</p>
                         </div>
                    </div>

                                    <div class="card bg-gradient-to-br from-emerald-500 to-teal-600 text-white border-none shadow-lg shadow-emerald-200 mb-6 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full blur-2xl -translate-y-1/2 translate-x-1/4"></div>
                        <h3 class="font-bold text-lg mb-2 relative z-10">${t('new_recording')}</h3>
                        <p class="text-emerald-100 text-sm mb-6 relative z-10">${t('ensure_quiet')}</p>
                        <button onclick="startTest()" class="w-full bg-white text-emerald-700 py-3.5 rounded-xl font-bold shadow-lg hover:bg-emerald-50 transition flex items-center justify-center gap-2 relative z-10">
                            <i data-lucide="mic" class="w-5 h-5"></i> ${t('start_test')}
                        </button>
                    </div>

                                            <div class="grid grid-cols-2 gap-4 mb-6">
                                                <div onclick="switchTab('history')" class="card p-4 flex flex-col justify-between h-32 relative overflow-hidden group cursor-pointer hover:shadow-md transition">
                            <div class="absolute right-[-10px] top-[-10px] bg-emerald-100 w-16 h-16 rounded-full opacity-50"></div>
                            <div>
                                <span class="text-xs font-bold text-emerald-500 uppercase tracking-wider">Last Void</span>
                                <h3 class="text-2xl font-bold text-emerald-900 mt-1">${lastRecord.qMax} <span class="text-sm font-normal text-emerald-600">ml/s</span></h3>
                            </div>
                            <div class="text-xs text-gray-400">Vol: ${lastRecord.volume}ml</div>
                        </div>

                                                                <div onclick="switchTab('diary')" class="card p-4 flex flex-col justify-between h-32 relative overflow-hidden cursor-pointer hover:shadow-md transition">
                            <div class="absolute right-[-10px] top-[-10px] bg-blue-100 w-16 h-16 rounded-full opacity-50"></div>
                            <div>
                                <span class="text-xs font-bold text-blue-500 uppercase tracking-wider">Hydration</span>
                                <h3 class="text-2xl font-bold text-emerald-900 mt-1">${todayIntake} <span class="text-sm font-normal text-emerald-600">ml</span></h3>
                            </div>
                                                        <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden mt-2">
                                <div class="bg-blue-400 h-full rounded-full" style="width: ${intakeProgress}%"></div>
                            </div>
                        </div>

                                                                <div onclick="showIPSSInfo(${userProfile.ipss || 0})" class="card p-4 flex flex-col justify-between h-32 relative overflow-hidden col-span-2 bg-gradient-to-r from-white to-gray-50 cursor-pointer hover:shadow-md transition">
                            <div class="absolute right-[-10px] top-[-10px] bg-purple-100 w-16 h-16 rounded-full opacity-50"></div>
                            <div class="flex justify-between items-start relative z-10">
                                <div>
                                    <span class="text-xs font-bold text-purple-500 uppercase tracking-wider">IPSS Score</span>
                                    <h3 class="text-2xl font-bold text-emerald-900 mt-1">${userProfile.ipss || 0}</h3>
                                    <p class="text-xs text-gray-400 mt-1">Click for significance</p>
                                </div>
                                <i data-lucide="info" class="w-5 h-5 text-gray-300"></i>
                            </div>
                        </div>
                    </div>

                                                    <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="bg-emerald-50 p-2 rounded-full">
                                <i data-lucide="user" class="w-5 h-5 text-emerald-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-bold text-gray-800">${userProfile.name}</p>
                                <p class="text-xs text-gray-500">${userProfile.age} ${t('years')} • ${t(userProfile.gender.toLowerCase())}</p>
                            </div>
                        </div>
                        <button onclick="editProfile()" class="text-xs font-bold text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-lg">${t('edit_details')}</button>
                    </div>
                </div>
            `;
        } else if (currentPage === 'edit-profile') {
            if (profileStep === 1) {
                html = `<div class="fade-in space-y-4"><h2 class="text-xl font-bold text-emerald-900 mb-4">${t('step_demographics')}</h2><div class="card space-y-5"><div><label class="block text-xs font-semibold text-emerald-600 uppercase mb-1">${t('display_name')}</label><input type="text" id="edit-name" value="${userProfile.name}" class="flow-input"></div><div><label class="block text-xs font-semibold text-emerald-600 uppercase mb-1">${t('age')}</label><input type="number" id="edit-age" value="${userProfile.age}" class="flow-input"></div><div><label class="block text-xs font-semibold text-emerald-600 uppercase mb-2">${t('gender')}</label><div class="flex gap-2"><button onclick="updateProfileAttribute('gender', 'Male')" class="flex-1 p-3 rounded-xl border-2 transition-all ${userProfile.gender === 'Male' ? 'border-emerald-600 bg-emerald-50 text-emerald-800 font-bold' : 'border-gray-200 text-gray-500'}">${t('male')}</button><button onclick="updateProfileAttribute('gender', 'Female')" class="flex-1 p-3 rounded-xl border-2 transition-all ${userProfile.gender === 'Female' ? 'border-emerald-600 bg-emerald-50 text-emerald-800 font-bold' : 'border-gray-200 text-gray-500'}">${t('female')}</button></div></div><div><label class="block text-xs font-semibold text-emerald-600 uppercase mb-2">${t('toilet_type')}</label><div class="flex gap-2"><button onclick="updateProfileAttribute('toiletType', 'Western')" class="flex-1 p-3 rounded-xl border-2 transition-all ${userProfile.toiletType === 'Western' ? 'border-emerald-600 bg-emerald-50 text-emerald-800 font-bold' : 'border-gray-200 text-gray-500'}">${t('western')}</button><button onclick="updateProfileAttribute('toiletType', 'Indian')" class="flex-1 p-3 rounded-xl border-2 transition-all ${userProfile.toiletType === 'Indian' ? 'border-emerald-600 bg-emerald-50 text-emerald-800 font-bold' : 'border-gray-200 text-gray-500'}">${t('indian')}</button><button onclick="updateProfileAttribute('toiletType', 'Urinal')" class="flex-1 p-3 rounded-xl border-2 transition-all ${userProfile.toiletType === 'Urinal' ? 'border-emerald-600 bg-emerald-50 text-emerald-800 font-bold' : 'border-gray-200 text-gray-500'}">${t('urinal')}</button></div></div></div><button onclick="goToIPSS()" class="btn w-full shadow-lg mt-4">${t('next_symptoms')}</button></div>`;
            } else {
                const questions = [
                    { q: t('ipss_q1'), sub: t('ipss_q1_sub') },
                    { q: t('ipss_q2'), sub: t('ipss_q2_sub') },
                    { q: t('ipss_q3'), sub: t('ipss_q3_sub') },
                    { q: t('ipss_q4'), sub: t('ipss_q4_sub') },
                    { q: t('ipss_q5'), sub: t('ipss_q5_sub') },
                    { q: t('ipss_q6'), sub: t('ipss_q6_sub') },
                    { q: t('ipss_q7'), sub: t('ipss_q7_sub') }
                ];
                const options = [0, 1, 2, 3, 4, 5];
                // MODIFIED HTML: Removed sticky score bar, added pb-24 for padding above fixed score bar
                html = `<div class="fade-in space-y-4 pb-24"><div class="flex items-center gap-2 mb-4"><button onclick="backToDemographics()" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left" class="w-5 h-5 text-gray-600"></i></button><h2 class="text-xl font-bold text-emerald-900">${t('step_symptoms')}</h2></div><div class="space-y-6">${questions.map((q, qIdx) => `<div class="card p-4"><h3 class="font-bold text-gray-800 mb-1">${qIdx + 1}. ${q.q}</h3><p class="text-xs text-gray-500 mb-3 leading-relaxed">${q.sub}</p><div class="grid grid-cols-1 gap-2">${options.map(score => { const isSelected = userProfile.ipssAnswers[qIdx] === parseInt(score); const selectedClass = isSelected ? 'bg-emerald-100 border-emerald-500 text-emerald-800 ring-1 ring-emerald-500' : 'bg-gray-50 border-gray-200 text-gray-600 hover:bg-gray-100'; const labelKey = qIdx === 6 ? 'ipss_nocturia_' + score : 'ipss_opt_' + score; return `<button onclick="setIPSSScore(${qIdx}, ${score})" class="w-full text-left px-3 py-2 rounded-lg border text-xs font-medium transition-all flex items-center justify-between ${selectedClass}"><span>${t(labelKey)}</span><span class="font-bold opacity-50">${score}</span></button>`; }).join('')}</div></div>`).join('')}</div><button onclick="saveFullProfile()" class="btn w-full shadow-lg mt-4">${t('save_changes')}</button></div>`;
            }
        } else if (currentPage === 'pre-recording') {
            html = `
                <div class="fade-in space-y-6 pt-4">
                    <h2 class="text-xl font-bold text-emerald-900 mb-2 px-2">${t('prep_header')}</h2>
                    
                    <div class="card space-y-4">
                        <div class="flex items-start gap-4">
                            <div class="bg-emerald-100 p-2 rounded-lg text-emerald-600 mt-1">
                                <i data-lucide="smartphone" class="w-5 h-5"></i>
                            </div>
                            <p class="text-sm text-emerald-800 leading-relaxed">${t('instr_dist')}</p>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="bg-emerald-100 p-2 rounded-lg text-emerald-600 mt-1">
                                <i data-lucide="volume-x" class="w-5 h-5"></i>
                            </div>
                            <p class="text-sm text-emerald-800 leading-relaxed">${t('instr_quiet')}</p>
                        </div>
                        <div class="flex items-start gap-4">
                            <div class="bg-emerald-100 p-2 rounded-lg text-emerald-600 mt-1">
                                <i data-lucide="play" class="w-5 h-5"></i>
                            </div>
                            <p class="text-sm text-emerald-800 leading-relaxed">${t('instr_void')}</p>
                        </div>
                    </div>

                    <div class="pt-4">
                        <button onclick="beginRecording()" class="btn w-full shadow-lg text-lg py-4">
                            <i data-lucide="mic" class="w-6 h-6 mr-2"></i> ${t('start_recording')}
                        </button>
                        <button onclick="goToHomeTab()" class="w-full py-4 text-center text-emerald-600 font-medium text-sm mt-2">${t('cancel_btn')}</button>
                    </div>
                </div>
            `;
        } else if (currentPage === 'mic-error') {
             html = `
                <div class="flex flex-col items-center justify-center h-full text-center fade-in space-y-6 pt-12">
                    <i data-lucide="mic-off" class="w-16 h-16 text-red-500"></i>
                    <h2 class="text-2xl font-bold text-gray-800">${t('error_mic_perm')}</h2>
                    <p class="text-gray-500 px-4">${t('error_mic_msg')}</p>
                    <button onclick="startTest()" class="btn">${t('retry')}</button>
                    <button onclick="goToHomeTab()" class="text-sm text-gray-500 underline">${t('home')}</button>
                </div>
            `;
        } 
        else if (currentPage === 'recording') {
            html = `
                <div class="flex flex-col items-center justify-center h-full text-center fade-in">
                    <div class="w-64 h-64 relative mb-4 flex items-center justify-center">
                        <div class="absolute w-full h-full rounded-full bg-red-100 animate-ping opacity-75"></div>
                        <div class="absolute w-48 h-48 rounded-full bg-red-200 animate-pulse"></div>
                        
                        <button onclick="stopTest()" class="relative w-32 h-32 bg-red-500 rounded-full shadow-xl flex items-center justify-center z-10 hover:scale-105 transition-transform">
                            <i data-lucide="square" class="w-12 h-12 text-white fill-current"></i>
                        </button>
                    </div>

                    <canvas id="recording-visualizer" class="w-48 h-16 mb-4 bg-gray-50 rounded-lg opacity-80"></canvas>
                    
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">${t('recording_title')}</h2>
                    <p class="text-gray-500 mb-6">${t('quiet_please')}</p>
                    
                    <button onclick="stopTest()" class="btn bg-gray-200 text-gray-700 hover:bg-gray-300">${t('stop_test')}</button>
                </div>
            `;
        } else if (currentPage === 'analysis') {
            const todayIntake = diaryEntries.filter(e => e.type === 'intake').reduce((acc, curr) => acc + curr.amount, 0);
            
            html = `
                <div class="fade-in space-y-4">
                    <div class="card p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-emerald-900">${t('flow_rate')}</h3>
                            <span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full font-medium">${t('complete')}</span>
                        </div>
                        <canvas id="result-graph" class="w-full h-48 rounded-lg mb-2"></canvas>
                    </div>

                    <div class="card p-4">
                        <h3 class="font-bold text-emerald-900 mb-3 border-b border-emerald-100 pb-2">${t('analysis_results')}</h3>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4 text-center">
                            <div>
                                <span class="text-xs text-gray-400 uppercase tracking-wider block mb-1">${t('max_flow')}</span>
                                <span class="text-xl font-bold text-emerald-900">${currentAnalysis.qMax} <small class="text-xs text-gray-500">ml/s</small></span>
                            </div>
                             <div>
                                <span class="text-xs text-gray-400 uppercase tracking-wider block mb-1">${t('avg_flow')}</span>
                                <span class="text-xl font-bold text-emerald-900">${currentAnalysis.qAve} <small class="text-xs text-gray-500">ml/s</small></span>
                            </div>
                        </div>

                         <div class="grid grid-cols-2 gap-4 mb-4 text-center">
                            <div>
                                <span class="text-xs text-gray-400 uppercase tracking-wider block mb-1">${t('total_vol')}</span>
                                <span class="text-xl font-bold text-emerald-900">${currentAnalysis.volume} <small class="text-xs text-gray-500">ml</small></span>
                            </div>
                            <div>
                                <span class="text-xs text-gray-400 uppercase tracking-wider block mb-1">${t('hydration_level')}</span>
                                <span class="text-xl font-bold text-teal-600">${todayIntake} <small class="text-xs text-gray-500">ml</small></span>
                            </div>
                        </div>

                                                                <div onclick="showIPSSInfo(${currentAnalysis.ipss || 0})" class="mb-4 bg-purple-50 border border-purple-100 rounded-xl p-3 flex justify-between items-center cursor-pointer">
                            <span class="text-xs font-bold text-purple-600 uppercase tracking-wider">IPSS Score</span>
                            <div class="flex items-center gap-2">
                                <span class="text-xl font-bold text-purple-900">${currentAnalysis.ipss || 0}</span>
                                <i data-lucide="info" class="w-4 h-4 text-purple-400"></i>
                            </div>
                        </div>

                        <div class="bg-emerald-50 rounded-xl p-3 grid grid-cols-3 gap-2 text-center text-sm">
                             <div>
                                <span class="block text-emerald-600/70 text-[10px] uppercase mb-1">${t('void_time')}</span>
                                <span class="font-semibold text-emerald-800">${currentAnalysis.voidTime}s</span>
                            </div>
                             <div>
                                <span class="block text-emerald-600/70 text-[10px] uppercase mb-1">${t('flow_time')}</span>
                                <span class="font-semibold text-emerald-800">${currentAnalysis.flowTime}s</span>
                            </div>
                             <div>
                                <span class="block text-emerald-600/70 text-[10px] uppercase mb-1">${t('time_to_max')}</span>
                                <span class="font-semibold text-emerald-800">${currentAnalysis.timeToMax}s</span>
                            </div>
                            <div class="col-span-3 border-t border-emerald-200 mt-2 pt-2 flex justify-between px-2">
                                <span class="text-emerald-600 text-xs">${t('hesitancy')}</span>
                                <span class="font-semibold text-emerald-800 text-xs">${currentAnalysis.hesitancy}s</span>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-teal-50 border-teal-100">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="sparkles" class="w-4 h-4 text-teal-600"></i>
                            <h3 class="font-bold text-teal-900">${t('smart_analysis')}</h3>
                        </div>
                        <p class="text-sm text-teal-800 leading-relaxed">${currentAnalysis.aiSummary}</p>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="exportData('pdf')" class="btn bg-gray-800 hover:bg-gray-900">
                            <i data-lucide="file-text" class="w-4 h-4"></i> ${t('pdf')}
                        </button>
                        <button onclick="exportData('csv')" class="btn btn-outline border-gray-300 text-gray-600 hover:bg-gray-100">
                            <i data-lucide="download" class="w-4 h-4"></i> ${t('csv')}
                        </button>
                    </div>
                    
                    <button onclick="shareReport()" class="btn w-full bg-emerald-600 hover:bg-emerald-700 shadow-lg mt-2">
                        <i data-lucide="share-2" class="w-4 h-4 mr-2"></i> ${t('share_doctor')}
                    </button>

                    <button onclick="resetHome()" class="w-full py-3 text-center text-emerald-700 font-medium text-sm mt-2">${t('home')}</button>
                </div>
            `;
        }
        
        appContent.innerHTML = html;
        lucide.createIcons();
        if (currentPage === 'analysis') drawGraph('result-graph', currentAnalysis.qMax);
        // Removed audio visualization trigger
        
        // New logic for the Fixed IPSS Score Bar
        if (currentPage === 'edit-profile' && profileStep === 2) {
            // FIXED: Removed dynamic JS calculation that was causing "floating in middle" issues
            // Use specific Tailwind classes to position it correctly above the nav bar
            fixedIpssScoreBar.classList.remove('opacity-0', 'pointer-events-none', '-translate-y-full', 'translate-y-full');
            // Add margin bottom to sit above nav bar (nav bar is approx 80px)
            fixedIpssScoreBar.classList.add('mb-20'); 

            fixedIpssScoreBar.innerHTML = `
                <div class="card bg-emerald-50 border-emerald-100 p-4 shadow-lg pointer-events-auto">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-emerald-900">${t('ipss_score_label')}</span>
                        <span class="text-2xl font-bold text-emerald-600">${userProfile.ipssAnswers.reduce((a,b)=>a+b,0)}</span>
                    </div>
                </div>
            `;
            lucide.createIcons(fixedIpssScoreBar);
        } else {
            // Hide the bar when not on the IPSS screen
            fixedIpssScoreBar.classList.add('opacity-0', 'pointer-events-none', 'translate-y-full');
            fixedIpssScoreBar.classList.remove('mb-20');
            fixedIpssScoreBar.innerHTML = '';
        }
    }

    // --- History Tab Render Logic ---
    function renderHistory() {
        fixedIpssScoreBar.classList.add('opacity-0', 'pointer-events-none'); // Ensure fixed bar is hidden
        if (historyData.length === 0) {
            appContent.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center opacity-50">
                    <i data-lucide="clipboard-list" class="w-16 h-16 mb-4 text-emerald-400"></i>
                    <p class="text-emerald-800">${t('no_records')}</p>
                </div>`;
            lucide.createIcons();
            return;
        }

        const listItems = historyData.map(item => `
            <div class="card flex justify-between items-center p-4 cursor-pointer hover:shadow-md transition" onclick="viewHistoryItem(${item.id})">
                <div class="flex items-center gap-4">
                    <div class="bg-emerald-50 p-3 rounded-full text-emerald-600">
                        <i data-lucide="droplets" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <p class="font-bold text-emerald-900">${item.date}</p>
                        <p class="text-xs text-emerald-500">${item.time} • ${item.volume}ml</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-bold text-emerald-900">${item.qMax} <span class="text-xs font-normal">ml/s</span></p>
                    <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold ${item.rating === 'Normal' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">${item.rating}</span>
                </div>
            </div>
        `).join('');

        appContent.innerHTML = `
            <div class="fade-in">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="font-bold text-emerald-800">${t('recent_records')}</h2>
                    <button onclick="exportAllHistory()" class="text-xs text-emerald-600 font-bold flex items-center gap-1">
                        <i data-lucide="download-cloud" class="w-3 h-3"></i> ${t('export_all')}
                    </button>
                </div>
                <div class="space-y-2">
                    ${listItems}
                </div>
            </div>
        `;
        lucide.createIcons();
    }

    // --- Education Logic preserved) ---
    function renderEducation() {
        fixedIpssScoreBar.classList.add('opacity-0', 'pointer-events-none'); // Ensure fixed bar is hidden
        appContent.innerHTML = `
            <div class="fade-in space-y-4">
                <div class="card bg-gradient-to-r from-emerald-500 to-teal-600 text-white border-none shadow-md shadow-emerald-200">
                    <h3 class="font-bold text-lg mb-1">${t('understanding_flow')}</h3>
                    <p class="text-emerald-50 text-sm">${t('understanding_desc')}</p>
                </div>

                <div class="space-y-2">
                    ${renderAccordion(t('qmax_title'), t('qmax_desc'))}
                    ${renderAccordion(t('vol_title'), t('vol_desc'))}
                    ${renderAccordion('Flow Time vs Void Time', 'Voiding time includes the entire duration including interruptions. Flow time is strictly the time urine is actually flowing.')}
                    ${renderAccordion(t('doc_title'), t('doc_desc'))}
                </div>
                
                <div class="mt-6 p-4 bg-orange-50 rounded-xl border border-orange-100">
                    <div class="flex gap-3">
                        <i data-lucide="alert-triangle" class="w-6 h-6 text-orange-500 flex-shrink-0"></i>
                        <p class="text-xs text-orange-800 leading-relaxed">
                            <strong>${t('disclaimer')}:</strong> ${t('disclaimer_text')}
                        </p>
                    </div>
                </div>
            </div>
        `;
        lucide.createIcons();
    }

    function renderAccordion(title, content) {
        const id = Math.random().toString(36).substr(2, 9);
        return `
            <div class="card p-0 overflow-hidden">
                <button onclick="toggleAccordion('${id}')" class="w-full flex justify-between items-center p-4 text-left font-semibold text-emerald-800 hover:bg-emerald-50 transition-colors">
                    ${title}
                    <i id="icon-${id}" data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                </button>
                <div id="${id}" class="accordion-content bg-emerald-50/50 px-4 text-sm text-emerald-700/80">
                    <div class="pb-4 pt-0 leading-relaxed">${content}</div>
                </div>
            </div>
        `;
    }

    window.toggleAccordion = (id) => {
        const content = document.getElementById(id);
        const icon = document.getElementById(`icon-${id}`);
        if (content.classList.contains('open')) {
            content.classList.remove('open');
            icon.style.transform = 'rotate(0deg)';
        } else {
            content.classList.add('open');
            icon.style.transform = 'rotate(180deg)';
        }
    };


    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
        try {
            const seenTutorial = localStorage.getItem('seenTutorial');
            if (seenTutorial) {
                appHeader.style.display = 'flex';
                appNav.style.display = 'flex';
                currentPage = 'onboarding';
                renderHome();
            } else {
                renderTutorial();
            }
        } catch(e) { renderTutorial(); }
        document.getElementById('loading-screen').style.display = 'none';
    });

</script>
</body>
</html>
